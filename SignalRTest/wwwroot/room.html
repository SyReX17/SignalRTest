<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link type="text/css" rel="stylesheet" href="vendors/materialize/materialize.min.css">
        <link rel="stylesheet" href="styles/common.css">
        <link rel="stylesheet" href="styles/room.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,1,0" />
        <title> Room interface </title>
    </head>
    <body class="blue-grey lighten-4">
        <div class="wrap">
            <div class="content">
                <div class="fhead">
                    <div class="fhead__container">
                        <h2 class="h__main" id="roomname"></h2>
                    </div>
                </div>
                <div class="call">
                    <div class="call__container">
                        <div class="call__partlist">
                            <h5>Participants: </h5>
                            <table class="table table-condensed table-striped table-bordered centered striped">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="call__interface">
                            <div class="call__view">
                                    <video id="localVideo1" autoplay="true"></video>
                                    <video id="remoteVideo1" autoplay=true></video>
                                    <video id="remoteVideo2" autoplay=true></video>
                            </div>
                            <div class="call__input">
                                <div class="input__items">
                                    <div class="input__btn">
                                        <a class="btn-floating btn-large waves-effect waves-light teal lighten-2 ">
                                            <span class="material-symbols-outlined">
                                                mic
                                            </span>
                                        </a>
                                    </div>
                                    <div class="input__btn">
                                        <a class="btn-floating btn-large waves-effect waves-light teal lighten-2">
                                            <span class="material-symbols-outlined">
                                                videocam
                                            </span>
                                        </a>
                                    </div>
                                    <div class="input__btn">
                                        <a id="close" class="btn-floating btn-large waves-effect waves-light red">
                                            <span class="material-symbols-outlined">
                                                call_end
                                            </span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="ftr">
                <div class="ftr__container">
                    <div class="ftr__text">
                        <p>footer</p>
                    </div>
                </div>
            </footer>
        </div>
        <script src="vendors/signalr/dist/browser/signalr.min.js"></script>
        <script type="text/javascript" src="vendors/materialize/materialize.min.js"></script>
        <script>

            const localvideo = document.getElementById('#localVideo1');
            const remotevideo = document.getElementById('#remoteVideo1');
            let roomName = getCookie("name");
            let rn = document.getElementById('roomname');
            rn.append(roomName);

            function getCookie(name) {
                let matches = document.cookie.match(new RegExp(
                    "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
                ));
                return matches ? decodeURIComponent(matches[1]) : undefined;
            }


            async function f() {

                let promise = new Promise((resolve, reject) => {
                    setTimeout(() => resolve("готово!"), 1000)
                });

                let result = await promise;
                hubConnection.invoke("Join", roomName);
            }

            let connections = new Map();


            const hubConnection = new signalR.HubConnectionBuilder()
                .withUrl("/chat")
                .build();


            document.getElementById("close").addEventListener("click", function (e) {
                e.preventDefault();
                hubConnection.invoke("Leave", roomName);
                window.location.href = '/index.html';
            });

            var constraints = { audio: true, video: { width: 1280, height: 720 } };

            navigator.mediaDevices.getUserMedia(constraints)
            .then(function(mediaStream) {
                var video = document.querySelector('#localVideo1');
                video.srcObject = mediaStream;

                const mediaTrack = mediaStream.getTracks()[0];
                video.onloadedmetadata = function(e) {
                    video.play();
                };



                hubConnection.on('RoomInfo', function (users) {
                    console.log("WORK");
                    TableClear();

                    console.log(users);
                    const rows = document.querySelector("tbody");
                    users.forEach(user => {
                        rows.append(getUsername(user))
                    });
                });


                

                hubConnection.on('AddPeer', async function (connectionId, addPeer) {
                    if (connections.has(connectionId)) {
                        console.log("already connected");
                    }

                    let peerConnection = new RTCPeerConnection();

                    connections.set(connectionId, peerConnection);

                    connections.get(connectionId).onicecandidate = event => {
                        if (event.candidate) {
                            hubConnection.invoke("RelayICE", connectionId, event.candidate);
                        }
                    }

                    let tracksNumber = 0;
                    connections.get(connectionId).ontrack = ({ streams: [remoteStream] }) => {
                        tracksNumber++

                        if (tracksNumber === 2) { // video & audio tracks received
                            tracksNumber = 0;
                            remotevideo.srcObject = remoteStream;
                        }
                    }

                    mediaStream.getTracks().forEach(track => {
                        console.log(track);
                        connections.get(connectionId).addTrack(track, mediaStream);
                    });
                    if (addPeer) {
                        let offer = await peerConnection.createOffer();
                        peerConnection.setLocalDescription(offer);

                        console.log(offer);

                        hubConnection.invoke("RelaySDP", connectionId, JSON.stringify(offer));
                    }
                });

                hubConnection.on('SessionDescription', async function (connectionId, remoteDescription) {

                    remoteDescription = JSON.parse(remoteDescription);
                    await connections.get(connectionId).setRemoteDescription(
                        new RTCSessionDescription(remoteDescription)
                    );


                    if (remoteDescription.type === 'offer') {
                        const answer = await connections.get(connectionId).createAnswer();

                        await connections.get(connectionId).setLocalDescription(answer);

                        hubConnection.invoke("RelaySDP", connectionId, JSON.stringify(answer));
                    }
                });

                hubConnection.on('IceCandidate', function (connectionId, iceCandidate) {
                    connections.get(connectionId).addIceCandidate(
                        new RTCIceCandidate(iceCandidate)
                    );
                });

                hubConnection.on('RemovePeer', function (connectionId) {
                    if (connections.has(connectionId)) {
                        connections.get(connectionId).close();
                    }

                    connections.delete(connectionId);
                });
            })
            .catch(function(err) { console.log(err.name + ": " + err.message); }); // always check for errors at the end.


            function TableClear() {
                const tableBody = document.querySelector("tbody");
                while (tableBody.firstChild) {
                    tableBody.removeChild(tableBody.firstChild);
                }
            }

            function getUsername(user) {
                const tr = document.createElement("tr");
                tr.setAttribute("data-rowid", user);


                const nameTd = document.createElement("td");
                nameTd.append(user);
                tr.append(nameTd);

                return tr;
            }

            hubConnection.start();

            f();
        </script>
    </body>
</html>