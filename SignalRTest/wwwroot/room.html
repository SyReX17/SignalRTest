<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link type="text/css" rel="stylesheet" href="vendors/materialize/materialize.min.css">
        <link rel="stylesheet" href="styles/common.css">
        <link rel="stylesheet" href="styles/room.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,1,0" />
        <title> Room interface </title>
    </head>
    <body class="blue-grey lighten-4">
        <div class="wrap">
            <div class="content">
                <div class="fhead">
                    <div class="fhead__container">
                        <h2 class="h__main" id="roomname"></h2>
                        <input type="button" id="roomBtn" value="Room" />
                    </div>
                </div>
                <div class="call">
                    <div class="call__container">
                        <div class="call__partlist">
                            <h5>Participants: </h5>
                            <table class="table table-condensed table-striped table-bordered centered striped">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="call__interface">
                            <div class="call__view">
                                <div class="call__video">
                                    <div class="video__vid">
                                        <p class="calltext"> video </p>
                                    </div>
                                    <div class="video__title">
                                        <p class="calltext"> Leonid Medov</p>
                                    </div>
                                </div>
                                <div class="call__video">
                                    <div class="video__vid">
                                        <p class="calltext"> video </p>
                                    </div>
                                    <div class="video__title">
                                        <p class="calltext"> Artyom Askarov</p>
                                    </div>
                                </div>
                                <div class="call__video">
                                    <div class="video__vid">
                                        <p class="calltext"> video </p>
                                    </div>
                                    <div class="video__title">
                                        <p class="calltext"> Andrey Almosov</p>
                                    </div>
                                </div>
                            </div>
                            <div class="call__input">
                                <div class="input__items">
                                    <div class="input__btn">
                                        <a class="btn-floating btn-large waves-effect waves-light teal lighten-2 ">
                                            <span class="material-symbols-outlined">
                                                mic
                                            </span>
                                        </a>
                                    </div>
                                    <div class="input__btn">
                                        <a class="btn-floating btn-large waves-effect waves-light teal lighten-2">
                                            <span class="material-symbols-outlined">
                                                videocam
                                            </span>
                                        </a>
                                    </div>
                                    <div class="input__btn">
                                        <a id="close" class="btn-floating btn-large waves-effect waves-light red">
                                            <span class="material-symbols-outlined">
                                                call_end
                                            </span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="ftr">
                <div class="ftr__container">
                    <div class="ftr__text">
                        <p>footer</p>
                    </div>
                </div>
            </footer>
        </div>
        <script src="vendors/signalr/dist/browser/signalr.min.js"></script>
        <script type="text/javascript" src="vendors/materialize/materialize.min.js"></script>
        <script>
            let roomName = getCookie("name");
            let rn = document.getElementById('roomname');
            rn.append(roomName);

            function getCookie(name) {
                let matches = document.cookie.match(new RegExp(
                    "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
                ));
                return matches ? decodeURIComponent(matches[1]) : undefined;
            }

            const hubConnection = new signalR.HubConnectionBuilder()
                .withUrl("/chat")
                .build();

            document.getElementById("roomBtn").addEventListener("click", function (e) {
                hubConnection.invoke("Join", roomName);
            });

            document.getElementById("close").addEventListener("click", function (e) {
                e.preventDefault();
                hubConnection.invoke("Leave", roomName);
                window.location.href = '/index.html';
            });


            

            hubConnection.on('RoomInfo', function (users) {
                console.log("WORK");
                TableClear();

                console.log(users);
                const rows = document.querySelector("tbody");
                users.forEach(user => {
                    rows.append(getUsername(user))
                });
            });
            function TableClear() {
                const tableBody = document.querySelector("tbody");
                while (tableBody.firstChild) {
                    tableBody.removeChild(tableBody.firstChild);
                }
            }

            function getUsername(user) {
                const tr = document.createElement("tr");
                tr.setAttribute("data-rowid", user);


                const nameTd = document.createElement("td");
                nameTd.append(user);
                tr.append(nameTd);

                return tr;
            }

            hubConnection.start();
        </script>
    </body>
</html>